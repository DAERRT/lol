@model List<lol.Models.Message>
@{
    Layout = "~/Views/Shared/_MessengerLayout.cshtml";
    var interlocutor = ViewBag.Interlocutor;
}
<div class="chat-area d-flex flex-column h-100" style="min-height:0;">
    <div class="chat-header d-flex align-items-center justify-content-between p-3 border-bottom bg-white position-relative">
        <div class="d-flex align-items-center gap-2 chat-header-clickable" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#userProfileModal">
            @if (interlocutor != null)
            {
                <img src="@(string.IsNullOrEmpty(interlocutor.AvatarPath) ? "/images/avatars/default.png" : interlocutor.AvatarPath)" alt="ĞĞ²Ğ°Ñ‚Ğ°Ñ€" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                <span class="fw-bold">@interlocutor.FirstName @interlocutor.LastName</span>
            }
            else
            {
                <h4 id="chatTitle" class="mb-0">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</h4>
            }
        </div>
        <div class="d-flex align-items-center gap-2">
            <button id="searchToggleBtn" class="btn btn-light btn-sm" title="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼"><i class="bi bi-search"></i></button>
            <div id="searchBox" class="search-popup shadow-sm p-2 bg-white rounded d-none">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="ĞŸĞ¾Ğ¸ÑĞº..." autocomplete="off" style="width: 180px;" />
                    <button id="searchPrevBtn" class="btn btn-outline-secondary btn-sm px-2"><i class="bi bi-chevron-up"></i></button>
                    <span id="searchCount" class="small text-muted">0/0</span>
                    <button id="searchNextBtn" class="btn btn-outline-secondary btn-sm px-2"><i class="bi bi-chevron-down"></i></button>
                    <button id="searchCloseBtn" class="btn-close ms-1" aria-label="Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ"></button>
                </div>
            </div>
            <button id="inviteButton" class="btn btn-outline-primary btn-sm" style="display: none;">+</button>
        </div>
    </div>
    <div id="messagesList" class="flex-grow-1 p-3" style="overflow-y:auto; min-height:0; background: #f8f9fa;">
        @foreach (var msg in Model)
        {
            <div class="mb-2 d-flex @(msg.UserId == ViewBag.UserId ? "justify-content-end" : "justify-content-start") message-item">
                <div class="message message-bubble @(msg.UserId == ViewBag.UserId ? "my-message" : "their-message") position-relative" data-message-id="@msg.Id">
                    @if (msg.ReplyToMessage != null)
                    {
                        <div class="reply-text reply-quote mb-1 p-2 rounded bg-light border" data-reply-to-id="@msg.ReplyToMessageId">
                            <span class="fw-bold small">@msg.ReplyToMessage.User.FirstName @msg.ReplyToMessage.User.LastName:</span>
                            <span class="text-muted small">@msg.ReplyToMessage.Text</span>
                        </div>
                    }
                    <div class="fw-bold small">@msg.User.FirstName @msg.User.LastName</div>
                    <div class="d-flex align-items-center">
                        <div class="message-text flex-grow-1">@msg.Text</div>
                        <span class="message-status"></span>
                        <button class="btn btn-link btn-sm reply-btn ms-2 px-1 py-0" title="ĞÑ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ" data-message-id="@msg.Id" data-message-text="@msg.Text" data-message-author="@msg.User.FirstName @msg.User.LastName"><i class="bi bi-reply"></i></button>
                    </div>
                    @if (msg.Attachments != null && msg.Attachments.Any())
                    {
                        <div class="attachments-list mt-2">
                            @foreach (var att in msg.Attachments)
                            {
                                <div class="attachment-item d-inline-flex align-items-center me-2 mb-1 p-1 px-2 rounded">
                                    @if (att.ContentType != null && att.ContentType.StartsWith("image/"))
                                    {
                                        <a href="@att.FilePath" target="_blank" class="me-2"><img src="@att.FilePath" alt="@att.FileName" style="max-width:48px;max-height:48px;border-radius:6px;object-fit:cover;box-shadow:0 2px 8px #0001;"></a>
                                    }
                                    else if (att.ContentType != null && att.ContentType.StartsWith("video/"))
                                    {
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#mediaPreviewModal" class="me-2 position-relative video-preview-link" style="display:inline-block;width:48px;height:48px;" data-video-src="@att.FilePath">
                                            <video src="@att.FilePath" style="width:48px;height:48px;object-fit:cover;border-radius:6px;box-shadow:0 2px 8px #0001;pointer-events:none;" preload="metadata"></video>
                                            <span class="position-absolute top-50 start-50 translate-middle" style="font-size:1.3em;color:#fff;text-shadow:0 2px 8px #000a;pointer-events:none;"><i class="bi bi-play-circle-fill"></i></span>
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="file-icon me-2">
                                            <i class="bi bi-file-earmark"></i>
                                        </span>
                                    }
                                    <div class="file-info">
                                        <a href="@att.FilePath" target="_blank" class="file-name d-block text-decoration-none text-primary" style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">@att.FileName</a>
                                        <span class="file-size small text-muted">@((att.FileSize / 1024.0 / 1024.0).ToString("0.##")) ĞœĞ‘</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    <div class="text-muted small text-end mt-1">@msg.SentAt.ToLocalTime().ToString("g")</div>
                </div>
            </div>
        }
    </div>
    <div id="replyPreview" class="reply-preview d-none align-items-center p-2 border-start border-4 border-primary bg-light mb-2" style="max-width: 500px;">
        <span class="fw-bold me-2" id="replyAuthor"></span>
        <span class="text-muted small me-2" id="replyText"></span>
        <button type="button" class="btn-close ms-auto" id="cancelReplyBtn" aria-label="ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"></button>
    </div>
    <div id="filePreviewList" class="file-preview-list mb-2" style="display:none;"></div>
    <form id="sendMessageForm" class="d-flex p-3 border-top gap-2 bg-white" style="flex-shrink:0; position:relative;">
        <input type="hidden" id="replyToMessageId" name="replyToMessageId" />
        <label for="fileInput" class="btn btn-light btn-sm d-flex align-items-center justify-content-center" style="height:38px;width:38px;padding:0;">
            <i class="bi bi-paperclip" style="font-size:1.3em;"></i>
        </label>
        <input type="file" id="fileInput" name="files" multiple style="display:none;" />
        <button type="button" id="emojiBtn" class="btn btn-light btn-sm d-flex align-items-center justify-content-center" style="height:38px;width:38px;padding:0;" tabindex="-1" title="Ğ¡Ğ¼Ğ°Ğ¹Ğ»Ğ¸ĞºĞ¸">
            <i class="bi bi-emoji-smile" style="font-size:1.3em;"></i>
        </button>
        <div id="emojiPanel" class="shadow rounded bg-white p-2" style="display:none;position:absolute;bottom:56px;left:60px;z-index:2000;width:320px;max-width:90vw;">
            <div class="d-flex mb-2 gap-1" id="emojiCategories">
                <button type="button" class="btn btn-light btn-sm emoji-cat-btn active" data-cat="smileys">ğŸ˜Š</button>
                <button type="button" class="btn btn-light btn-sm emoji-cat-btn" data-cat="animals">ğŸ»</button>
                <button type="button" class="btn btn-light btn-sm emoji-cat-btn" data-cat="food">ğŸ”</button>
                <button type="button" class="btn btn-light btn-sm emoji-cat-btn" data-cat="activity">âš½</button>
                <button type="button" class="btn btn-light btn-sm emoji-cat-btn" data-cat="travel">ğŸš—</button>
                <button type="button" class="btn btn-light btn-sm emoji-cat-btn" data-cat="symbols">â¤ï¸</button>
            </div>
            <div id="emojiList" style="max-height:180px;overflow-y:auto;font-size:1.5em;"></div>
        </div>
        <textarea id="messageInput" class="form-control message-input-area" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." autocomplete="off" rows="1" style="resize:none;"></textarea>
        <button type="submit" class="btn btn-primary">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
    </form>
</div>
@section Styles {
    <style>
        .chat-header { background: #fff; color: #222; position: relative; }
        .chat-header img { margin-right: 10px; }
        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            background: #fff;
        }
        #messagesList {
            flex: 1 1 auto;
            overflow-y: auto;
            background: #f8f9fa;
            min-height: 0;
        }
        form#sendMessageForm {
            flex-shrink: 0;
            background: #fff;
        }
        .message-bubble { max-width: 60%; padding: 10px 15px; border-radius: 16px; background: #f1f3f6; color: #222; box-shadow: 0 2px 8px #0001; }
        .message-text {
            word-break: break-word;
            overflow-wrap: anywhere;
            white-space: pre-line;
        }
        .my-message { background: #e6eaff; color: #222; align-self: flex-end; }
        .their-message { background: #f1f3f6; color: #222; align-self: flex-start; }
        .search-popup {
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 10;
            min-width: 290px;
            max-width: 340px;
            padding-right: 0;
            display: block;
            box-shadow: 0 4px 16px #0002;
        }
        .search-popup.d-none { display: none !important; }
        .search-popup input { width: 180px; }
        .highlight-search {
            background: #fff8c6;
            border-radius: 4px;
            padding: 0 2px;
            font-weight: 500;
        }
        .current-search {
            background: #ffe066 !important;
            border: 1.5px solid #ffd700;
            font-weight: bold;
            box-shadow: 0 0 0 2px #ffd70033;
        }
        .reply-btn {
            opacity: 0.5;
            font-size: 1.1em;
            transition: opacity 0.2s;
            vertical-align: middle;
        }
        .message-bubble:hover .reply-btn {
            opacity: 1;
        }
        .reply-preview {
            border-left: 4px solid #0d6efd;
            background: #f1f3f6;
            border-radius: 6px;
            margin-left: 12px;
        }
        .reply-quote {
            border-left: 3px solid #6c47ff;
            background: #f6f6ff;
            font-size: 0.95em;
        }
        .message-input-area {
            min-height: 38px;
            max-height: 120px;
            resize: none;
            overflow-y: auto;
        }
        .reply-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-header-clickable:hover {
            background: #f6f6ff;
            transition: background 0.2s;
        }
        #userProfileModal .modal-content {
            background: #23232b;
            color: #fff;
            border-radius: 16px;
        }
        #userProfileModal .modal-header {
            border-bottom: none;
        }
        #userProfileModal .modal-body img {
            border: 3px solid #6c47ff;
        }
        #userProfileModal .nav-tabs .nav-link.active {
            background: #29293a;
            color: #fff;
            border: none;
        }
        #userProfileModal .nav-tabs .nav-link {
            color: #bbb;
        }
        .user-profile-sidebar {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 350px;
            background: rgba(255,255,255,0.20);
            color: #222;
            z-index: 1050;
            box-shadow: -2px 0 16px #0002;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(.4,0,.2,1);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(8px);
        }
        .main-content { position: relative; }
        .user-profile-sidebar.open {
            transform: translateX(0);
        }
        .user-profile-sidebar .sidebar-header {
            padding: 24px 24px 12px 24px;
            border-bottom: 1px solid #ececec;
            background: transparent;
            position: relative;
            color: #222;
        }
        .user-profile-sidebar .btn-close {
            position: absolute;
            right: 16px;
            top: 24px;
            filter: none;
        }
        .user-profile-sidebar .sidebar-body {
            flex: 1 1 auto;
            padding: 24px;
            overflow-y: auto;
        }
        .user-profile-sidebar .rounded-circle {
            border: 3px solid #6c47ff22;
        }
        .user-profile-sidebar .nav-tabs .nav-link.active {
            background: #f6f6ff;
            color: #6c47ff;
            border: none;
        }
        .user-profile-sidebar .nav-tabs .nav-link {
            color: #888;
        }
        .file-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            min-height: 32px;
        }
        .file-preview-item {
            background: #f6f6ff;
            border: 1px solid #ececec;
            border-radius: 8px;
            padding: 4px 10px 4px 6px;
            display: flex;
            align-items: center;
            font-size: 0.95em;
            max-width: 220px;
            box-shadow: 0 2px 8px #0001;
        }
        .file-preview-item .file-icon {
            font-size: 1.2em;
            margin-right: 6px;
        }
        .file-preview-item .file-remove {
            background: none;
            border: none;
            color: #888;
            margin-left: 8px;
            font-size: 1.1em;
            cursor: pointer;
        }
        .file-preview-item .file-remove:hover {
            color: #dc3545;
        }
        .file-preview-item .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 110px;
        }
        .file-preview-item .file-size {
            color: #888;
            font-size: 0.93em;
            margin-left: 6px;
        }
        .attachments-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 12px;
            margin-top: 4px;
        }
        .attachment-item {
            background: #f6f6ff;
            border: 1px solid #ececec;
            border-radius: 8px;
            padding: 4px 10px 4px 6px;
            display: flex;
            align-items: center;
            font-size: 0.97em;
            max-width: 220px;
            box-shadow: 0 2px 8px #0001;
            transition: box-shadow 0.2s;
        }
        .attachment-item:hover {
            box-shadow: 0 4px 16px #6c47ff22;
        }
        .attachment-item .file-icon {
            font-size: 1.5em;
            color: #6c47ff;
        }
        .attachment-item .file-info {
            min-width: 0;
        }
        .attachment-item .file-name {
            font-weight: 500;
            font-size: 1em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .attachment-item .file-size {
            font-size: 0.92em;
        }
        #mediaPreviewModal .modal-content {
            background: rgba(20,20,30,0.7) !important;
            backdrop-filter: blur(8px);
            border-radius: 16px;
            box-shadow: 0 4px 32px #000a;
        }
    </style>
}

<!-- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² -->
<div class="modal fade" id="inviteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="inviteUserSearchInput" class="form-control mb-2" placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ..." autocomplete="off" />
                <div id="inviteUserSearchResults" class="list-group mb-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Ğ‘Ğ¾ĞºĞ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ -->
@if (interlocutor != null)
{
<div id="userProfileSidebar" class="user-profile-sidebar">
    <div class="sidebar-header">
        <button type="button" class="btn-close btn-close-white float-end" id="closeUserProfileSidebar" aria-label="Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ"></button>
        <h5 class="mt-2">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</h5>
    </div>
    <div class="sidebar-body text-center">
        <img src="@(string.IsNullOrEmpty(interlocutor.AvatarPath) ? "/images/avatars/default.png" : interlocutor.AvatarPath)" alt="ĞĞ²Ğ°Ñ‚Ğ°Ñ€" class="rounded-circle mb-3" style="width:90px;height:90px;object-fit:cover;">
        <h4 class="fw-bold mb-1">@interlocutor.FirstName @interlocutor.LastName</h4>
        <div class="mt-4">
            <ul class="nav nav-tabs justify-content-center" id="profileTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="media-tab" data-bs-toggle="tab" data-bs-target="#media" type="button" role="tab" aria-controls="media" aria-selected="true">ĞœĞµĞ´Ğ¸Ğ°</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">Ğ¤Ğ°Ğ¹Ğ»Ñ‹</button>
                </li>
            </ul>
            <div class="tab-content mt-3" id="profileTabContent">
                <div class="tab-pane fade show active text-muted" id="media" role="tabpanel" aria-labelledby="media-tab">
                    <div id="mediaGallery" class="row g-2 justify-content-center"></div>
                </div>
                <div class="tab-pane fade text-muted" id="files" role="tabpanel" aria-labelledby="files-tab">
                    <div id="filesList" class="list-group"></div>
                </div>
            </div>
        </div>
    </div>
</div>
}

<!-- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ¼ĞµĞ´Ğ¸Ğ° -->
<div class="modal fade" id="mediaPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:90vw;">
        <div class="modal-content bg-dark text-white position-relative" style="background:rgba(20,20,30,0.7);border-radius:16px;backdrop-filter: blur(8px);">
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ" style="z-index:2;"></button>
            <div class="modal-body d-flex justify-content-center align-items-center" style="min-height:60vh;">
                <div id="mediaPreviewContent" class="w-100 text-center"></div>
            </div>
        </div>
    </div>
</div>

@if (interlocutor == null)
{
    <div id="groupChatSidebar" class="user-profile-sidebar">
        <div class="sidebar-header">
            <button type="button" class="btn-close btn-close-white float-end" id="closeGroupChatSidebar" aria-label="Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ"></button>
            <h5 class="mt-2">Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ñ‡Ğ°Ñ‚</h5>
        </div>
        <div class="sidebar-body text-center">
            <div style="position:relative;display:inline-block;">
                <img id="groupAvatarImg" src="@(ViewBag.GroupAvatarPath ?? "/images/avatars/group.png")" alt="ĞĞ²Ğ°Ñ‚Ğ°Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹" class="rounded-circle mb-3" style="width:90px;height:90px;object-fit:cover;">
                <form id="groupAvatarForm" enctype="multipart/form-data" style="position:absolute;bottom:8px;right:8px;">
                    <label for="groupAvatarInput" style="cursor:pointer;background:#fff;border-radius:50%;padding:4px;box-shadow:0 2px 8px #0002;">
                        <i class="bi bi-camera" style="font-size:1.3em;"></i>
                    </label>
                    <input type="file" id="groupAvatarInput" name="avatar" accept="image/*" style="display:none;" />
                </form>
            </div>
            <h4 class="fw-bold mb-1" id="groupChatTitle">@ViewBag.ChatTitle ?? "Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ñ‡Ğ°Ñ‚"</h4>
            <div class="mt-2 mb-3">
                <div class="small text-muted" id="chatParticipants">Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸: ...</div>
            </div>
            <ul class="nav nav-tabs justify-content-center" id="groupProfileTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="group-media-tab" data-bs-toggle="tab" data-bs-target="#media" type="button" role="tab" aria-controls="media" aria-selected="true">ĞœĞµĞ´Ğ¸Ğ°</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="group-files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">Ğ¤Ğ°Ğ¹Ğ»Ñ‹</button>
                </li>
            </ul>
            <div class="tab-content mt-3" id="groupProfileTabContent">
                <div class="tab-pane fade show active text-muted" id="media" role="tabpanel" aria-labelledby="group-media-tab">
                    <div id="mediaGallery" class="row g-2 justify-content-center"></div>
                </div>
                <div class="tab-pane fade text-muted" id="files" role="tabpanel" aria-labelledby="group-files-tab">
                    <div id="filesList" class="list-group"></div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script><script>
        const chatId = @ViewBag.ChatId;
        const userId = '@ViewBag.UserId';
        const userName = '@User.Identity.Name';
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        connection.start().then(function () {
            connection.invoke("JoinChat", chatId);
        });

        connection.on("ReceiveMessage", function (msgChatId, msgUserId, message) {
            if (msgChatId == chatId) {
                loadMessages();
            }
            // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½Ğµ Ñ‚Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
            if (msgUserId !== userId && window.Notification && Notification.permission === "granted") {
                new Notification("ĞĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Ñ‡Ğ°Ñ‚Ğµ", {
                    body: message,
                    icon: "/favicon.ico" // Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ¸ĞºĞ¾Ğ½ĞºĞµ
                });
            }
        });

        connection.on("UserInvited", function (invitedUserId, chatId, chatName) {
            if (invitedUserId === userId) {
                // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² ĞºĞ¾Ğ»Ğ¾ĞºĞ¾Ğ»ÑŒÑ‡Ğ¸Ğº
                connection.invoke("SendNotification", invitedUserId, "Ğ’Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ»Ğ¸ Ğ² Ñ‡Ğ°Ñ‚: " + chatName);
            }
        });

        function loadMessages() {
            $.get('/Chat/Messages?chatId=' + chatId, function (data) {
                const html = $(data).find('#messagesList').html();
                $('#messagesList').html(html);
                $('#messagesList').scrollTop($('#messagesList')[0].scrollHeight);
            });
        }

        // Ğ¡ĞºÑ€Ğ¾Ğ»Ğ»Ğ¸Ğ¼ Ğ²Ğ½Ğ¸Ğ· Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
        $(function () {
            $('#messagesList').scrollTop($('#messagesList')[0].scrollHeight);
        });

        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‡Ğ°Ñ‚Ğµ
        $.get('/Chat/GetChatInfo', { chatId: @ViewBag.ChatId }, function (data) {
            $('#chatTitle').text(data.name || (data.isGroup ? 'Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ñ‡Ğ°Ñ‚' : data.isTeamChat ? 'ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚' : 'Ğ›Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚'));
            if (data.isGroup || data.isTeamChat) {
                let participants = data.participants.map(p => p.firstName + ' ' + p.lastName).join(', ');
                $('#chatParticipants').text('Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸: ' + participants);
                $('#inviteButton').show();
            }
        });

        // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ñ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
        $('#inviteButton').on('click', function () {
            $('#inviteModal').modal('show');
        });
        $('#inviteUserSearchInput').on('input', function () {
            const query = $(this).val();
            if (!query) {
                $('#inviteUserSearchResults').empty();
                return;
            }
            $.get('/Chat/SearchUsers', { query: query }, function (data) {
                let html = '';
                data.forEach(function (u) {
                    html += `<button type="button" class="list-group-item list-group-item-action" onclick="inviteUser('${u.id}')">${u.firstName} ${u.lastName} (${u.userName})</button>`;
                });
                $('#inviteUserSearchResults').html(html);
            });
        });
        window.inviteUser = function (userId) {
            $.post('/Chat/InviteUser', { chatId: @ViewBag.ChatId, userId: userId }, function () {
                $('#inviteModal').modal('hide');
                // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‡Ğ°Ñ‚Ğµ
                $.get('/Chat/GetChatInfo', { chatId: @ViewBag.ChatId }, function (data) {
                    let participants = data.participants.map(p => p.firstName + ' ' + p.lastName).join(', ');
                    $('#chatParticipants').text('Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸: ' + participants);
                });
            });
        };

        // ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼
        let searchResults = [];
        let currentSearchIndex = 0;
        function updateSearchHighlights(query) {
            searchResults = [];
            currentSearchIndex = 0;
            $("#messagesList .message-text").each(function(i, el) {
                const $el = $(el);
                const text = $el.text();
                $el.html(text); // ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€ÑƒÑ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºÑƒ
                if (query && text.toLowerCase().includes(query.toLowerCase())) {
                    // ĞŸĞ¾Ğ´ÑĞ²ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ
                    const regex = new RegExp('('+query+')', 'gi');
                    $el.html(text.replace(regex, '<span class="highlight-search">$1</span>'));
                    // Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ¿Ğ¾ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸ÑĞ¼
                    $el.closest('.message-item').addClass('search-match');
                    searchResults.push($el.closest('.message-item')[0]);
                } else {
                    $el.closest('.message-item').removeClass('search-match');
                }
            });
            updateSearchCount();
            highlightCurrentSearch();
        }
        function updateSearchCount() {
            const count = searchResults.length;
            const current = count ? (currentSearchIndex + 1) : 0;
            $('#searchCount').text(current + '/' + count);
        }
        function highlightCurrentSearch() {
            $('.current-search').removeClass('current-search');
            if (searchResults.length > 0) {
                // ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ²ÑĞµ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‡ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ
                let allHighlights = [];
                $('#messagesList .highlight-search').each(function() {
                    allHighlights.push(this);
                });
                // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ, Ğº ĞºĞ°ĞºĞ¾Ğ¼Ñƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ
                let matchIndex = 0;
                for (let i = 0; i < searchResults.length; i++) {
                    if (searchResults[i] === searchResults[currentSearchIndex]) {
                        // ĞĞ°Ğ¹Ñ‚Ğ¸ n-Ğ¾Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ² ÑÑ‚Ğ¾Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸
                        let $msg = $(searchResults[i]);
                        let highlights = $msg.find('.highlight-search');
                        if (highlights.length > 0) {
                            $(highlights[0]).addClass('current-search');
                            highlights[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        break;
                    }
                }
            }
        }
        $('#searchToggleBtn').on('click', function() {
            $('#searchBox').toggleClass('d-none');
            if (!$('#searchBox').hasClass('d-none')) {
                $('#searchInput').focus();
            }
        });
        $('#searchCloseBtn').on('click', function() {
            $('#searchBox').addClass('d-none');
            $('#searchInput').val('');
            updateSearchHighlights('');
        });
        $('#searchInput').on('input', function() {
            const query = $(this).val();
            updateSearchHighlights(query);
        });
        $('#searchPrevBtn').on('click', function() {
            if (searchResults.length === 0) return;
            currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
            updateSearchCount();
            highlightCurrentSearch();
        });
        $('#searchNextBtn').on('click', function() {
            if (searchResults.length === 0) return;
            currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
            updateSearchCount();
            highlightCurrentSearch();
        });
        // Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ñ‡Ğ°Ñ‚Ğ°
        $(function() {
            $('#searchBox').addClass('d-none');
            $('#searchInput').val('');
            updateSearchHighlights('');
        });

        // --- ĞÑ‚Ğ²ĞµÑ‚ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ---
        let replyToId = null;
        $(document).on('click', '.reply-btn', function(e) {
            e.preventDefault();
            replyToId = $(this).data('message-id');
            const text = $(this).data('message-text');
            const author = $(this).data('message-author');
            $('#replyToMessageId').val(replyToId);
            $('#replyAuthor').text(author + ':');
            $('#replyText').text(text.length > 60 ? text.substring(0, 60) + 'â€¦' : text);
            $('#replyPreview').removeClass('d-none');
        });
        $('#cancelReplyBtn').on('click', function() {
            replyToId = null;
            $('#replyToMessageId').val('');
            $('#replyPreview').addClass('d-none');
        });
        // --- Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ---
        document.getElementById('sendMessageForm').addEventListener('submit', function(e) {
            const hasFiles = selectedFiles.length > 0;
            const text = document.getElementById('messageInput').value.trim();
            const replyId = document.getElementById('replyToMessageId').value;
            if (hasFiles) {
                e.preventDefault();
                if (selectedFiles.length === 0) return;
                const formData = new FormData();
                formData.append('chatId', chatId);
                formData.append('text', text);
                formData.append('replyToMessageId', replyId);
                selectedFiles.forEach(f => formData.append('files', f));
                fetch('/Chat/SendMessageWithFiles', {
                    method: 'POST',
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        selectedFiles = [];
                        renderFilePreview();
                        document.getElementById('messageInput').value = '';
                        document.getElementById('replyToMessageId').value = '';
                        $('#replyPreview').addClass('d-none');
                        replyToId = null;
                        // ĞĞ¿Ğ¾Ğ²ĞµÑ‰Ğ°ĞµĞ¼ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ¼
                        connection.invoke("SendMessageToChat", chatId, userId, text || '[Ğ¤Ğ°Ğ¹Ğ»]');
                        loadMessages && loadMessages();
                    } else {
                        alert(data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²!');
                    }
                })
                .catch(() => alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²!'));
                return false;
            } else {
                // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµĞºÑÑ‚ â€” Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· AJAX
                e.preventDefault();
                if (!text) return;
                $.post('/Chat/SendMessage', { chatId: chatId, text: text, replyToMessageId: replyId }, function () {
                    connection.invoke("SendMessageToChat", chatId, userId, text);
                    document.getElementById('messageInput').value = '';
                    document.getElementById('replyToMessageId').value = '';
                    $('#replyPreview').addClass('d-none');
                    replyToId = null;
                });
                return false;
            }
        }, true);

        // ĞĞ²Ñ‚Ğ¾Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ textarea
        function autoGrowTextarea(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }
        $(document).on('input', '#messageInput', function() {
            autoGrowTextarea(this);
        });
        $(function() {
            autoGrowTextarea(document.getElementById('messageInput'));
        });

        $(document).on('click', '.reply-text', function() {
            var replyToId = $(this).data('reply-to-id');
            if (replyToId) {
                var targetMessage = $('.message[data-message-id="' + replyToId + '"]');
                if (targetMessage.length) {
                    targetMessage[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        // ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ
        const sidebar = document.getElementById('userProfileSidebar');
        const groupSidebar = document.getElementById('groupChatSidebar');
        if (sidebar || groupSidebar) {
            document.querySelector('.chat-header-clickable').onclick = function() {
                if (sidebar) sidebar.classList.add('open');
                if (groupSidebar) groupSidebar.classList.add('open');
                renderProfileMediaAndFiles();
            };
            const closeBtn = document.getElementById('closeUserProfileSidebar');
            if (closeBtn && sidebar) {
                closeBtn.onclick = function() {
                    sidebar.classList.remove('open');
                };
            }
            const closeGroupBtn = document.getElementById('closeGroupChatSidebar');
            if (closeGroupBtn && groupSidebar) {
                closeGroupBtn.onclick = function() {
                    groupSidebar.classList.remove('open');
                };
            }
            document.addEventListener('mousedown', function(e) {
                if (sidebar && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !e.target.classList.contains('chat-header-clickable')) {
                    sidebar.classList.remove('open');
                }
                if (groupSidebar && groupSidebar.classList.contains('open') && !groupSidebar.contains(e.target) && !e.target.classList.contains('chat-header-clickable')) {
                    groupSidebar.classList.remove('open');
                }
            });
        }

        // --- Ğ¤Ğ°Ğ¹Ğ»Ñ‹ ---
        const MAX_FILE_SIZE = 200 * 1024 * 1024; // 200 ĞœĞ‘
        let selectedFiles = [];

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Ğ‘';
            const k = 1024;
            const sizes = ['Ğ‘', 'ĞšĞ‘', 'ĞœĞ‘', 'Ğ“Ğ‘'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileIcon(file) {
            // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ñ„Ğ°Ğ¹Ğ»Ğ°
            if (file.type.startsWith('image/')) return '<i class="bi bi-file-image"></i>';
            if (file.type.startsWith('video/')) return '<i class="bi bi-file-earmark-play"></i>';
            if (file.type.startsWith('audio/')) return '<i class="bi bi-file-music"></i>';
            if (file.type === 'application/pdf') return '<i class="bi bi-file-earmark-pdf"></i>';
            if (file.type.startsWith('application/zip') || file.name.endsWith('.rar')) return '<i class="bi bi-file-zip"></i>';
            return '<i class="bi bi-file-earmark"></i>';
        }

        function renderFilePreview() {
            const preview = document.getElementById('filePreviewList');
            preview.innerHTML = '';
            if (selectedFiles.length === 0) {
                preview.style.display = 'none';
                return;
            }
            preview.style.display = 'flex';
            selectedFiles.forEach((file, idx) => {
                const div = document.createElement('div');
                div.className = 'file-preview-item';
                div.innerHTML = `
                    <span class="file-icon">${getFileIcon(file)}</span>
                    <span class="file-name" title="${file.name}">${file.name}</span>
                    <span class="file-size">${formatBytes(file.size)}</span>
                    <button type="button" class="file-remove" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ" data-idx="${idx}"><i class="bi bi-x"></i></button>
                `;
                preview.appendChild(div);
            });
            // ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
            preview.querySelectorAll('.file-remove').forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(this.getAttribute('data-idx'));
                    selectedFiles.splice(idx, 1);
                    renderFilePreview();
                };
            });
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            let error = '';
            files.forEach(file => {
                if (file.size > MAX_FILE_SIZE) {
                    error = `Ğ¤Ğ°Ğ¹Ğ» "${file.name}" Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ 200 ĞœĞ‘ Ğ¸ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½.`;
                } else {
                    selectedFiles.push(file);
                }
            });
            if (error) {
                alert(error);
            }
            // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ input, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Ñ„Ğ°Ğ¹Ğ» ÑĞ½Ğ¾Ğ²Ğ°
            e.target.value = '';
            renderFilePreview();
        });

        // --- ĞœĞ•Ğ”Ğ˜Ğ Ğ¸ Ğ¤ĞĞ™Ğ›Ğ« Ğ² Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ ---
        function renderProfileMediaAndFiles() {
            $.get('/Chat/GetChatAttachments', { chatId: chatId }, function(data) {
                // ĞœĞµĞ´Ğ¸Ğ°
                const media = data.filter(a => a.contentType && (a.contentType.startsWith('image/') || a.contentType.startsWith('video/')));
                let mediaHtml = '';
                media.forEach(a => {
                    if (a.contentType.startsWith('image/')) {
                        mediaHtml += `<div class='col-auto'><span style='cursor:pointer;display:inline-block;'><img src='${a.filePath}' alt='' style='width:80px;height:80px;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px #0001;'></span></div>`;
                    } else if (a.contentType.startsWith('video/')) {
                        mediaHtml += `<div class='col-auto position-relative' style='width:80px;height:80px;'>
                            <span style='display:block;width:80px;height:80px;position:relative;cursor:pointer;'>
                                <video src='${a.filePath}' style='width:80px;height:80px;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px #0001;pointer-events:none;' preload='metadata'></video>
                                <span class='position-absolute top-50 start-50 translate-middle' style='font-size:2.2em;color:#fff;text-shadow:0 2px 8px #000a;pointer-events:none;'><i class='bi bi-play-circle-fill'></i></span>
                            </span>
                        </div>`;
                    }
                });
                $('#mediaGallery').html(mediaHtml || '<div class="text-muted">ĞĞµÑ‚ Ğ¼ĞµĞ´Ğ¸Ğ°Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²</div>');
                // Ğ¤Ğ°Ğ¹Ğ»Ñ‹
                const files = data.filter(a => !a.contentType || (!a.contentType.startsWith('image/') && !a.contentType.startsWith('video/')));
                let filesHtml = '';
                files.forEach(a => {
                    let icon = '<i class="bi bi-file-earmark"></i>';
                    if (a.contentType && a.contentType.startsWith('audio/')) icon = '<i class="bi bi-file-music"></i>';
                    if (a.contentType === 'application/pdf') icon = '<i class="bi bi-file-earmark-pdf"></i>';
                    if (a.contentType && (a.contentType.startsWith('application/zip') || (a.fileName && a.fileName.endsWith('.rar')))) icon = '<i class="bi bi-file-zip"></i>';
                    filesHtml += `<a href='${a.filePath}' target='_blank' class='list-group-item list-group-item-action d-flex align-items-center'><span class='me-2'>${icon}</span><span class='flex-grow-1 text-truncate'>${a.fileName || 'Ğ¤Ğ°Ğ¹Ğ»'}</span><span class='ms-2 small text-muted'>${(a.fileSize/1024/1024).toFixed(2)} ĞœĞ‘</span></a>`;
                });
                $('#filesList').html(filesHtml || '<div class="text-muted p-2">ĞĞµÑ‚ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²</div>');
            });
        }

        // --- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ¼ĞµĞ´Ğ¸Ğ° ---
        $(document).on('click', '.attachment-item img, .attachment-item video', function(e) {
            e.preventDefault();
            const src = $(this).attr('src');
            const isVideo = $(this).is('video');
            let html = '';
            if (isVideo) {
                html = `<video src='${src}' controls autoplay style='max-width:90vw;max-height:80vh;border-radius:12px;box-shadow:0 4px 32px #000a;'></video>`;
            } else {
                html = `<img src='${src}' alt='' style='max-width:90vw;max-height:80vh;border-radius:12px;box-shadow:0 4px 32px #000a;' />`;
            }
            $('#mediaPreviewContent').html(html);
            var modal = new bootstrap.Modal(document.getElementById('mediaPreviewModal'));
            modal.show();
        });

        $(document).on('click', '.video-preview-link', function(e) {
            e.preventDefault();
            var videoSrc = $(this).data('video-src');
            var html = `<video src='${videoSrc}' controls autoplay style='max-width:90vw;max-height:80vh;border-radius:12px;box-shadow:0 4px 32px #000a;'></video>`;
            $('#mediaPreviewContent').html(html);
        });
        // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ¸
        $('#mediaPreviewModal').on('hidden.bs.modal', function () {
            $('#mediaPreviewContent').html('');
        });

        // --- ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¼ĞµĞ´Ğ¸Ğ° Ğ¸Ğ· Ğ³Ğ°Ğ»ĞµÑ€ĞµĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ ---
        $(document).on('click', '#mediaGallery .col-auto', function(e) {
            e.preventDefault();
            let $img = $(this).find('img');
            let $video = $(this).find('video');
            let html = '';
            if ($video.length) {
                const src = $video.attr('src');
                html = `<video src='${src}' controls autoplay style='max-width:90vw;max-height:80vh;border-radius:12px;box-shadow:0 4px 32px #000a;'></video>`;
            } else if ($img.length) {
                const src = $img.attr('src');
                html = `<img src='${src}' alt='' style='max-width:90vw;max-height:80vh;border-radius:12px;box-shadow:0 4px 32px #000a;' />`;
            }
            if (html) {
                $('#mediaPreviewContent').html(html);
                var modal = new bootstrap.Modal(document.getElementById('mediaPreviewModal'));
                modal.show();
            }
        });

        // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‡Ğ°Ñ‚Ğµ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ³Ğ¾ sidebar
        $(function() {
            const groupSidebar = document.getElementById('groupChatSidebar');
            if (groupSidebar) {
                $.get('/Chat/GetChatInfo', { chatId: @ViewBag.ChatId }, function (data) {
                    $('#groupChatTitle').text(data.name || 'Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ñ‡Ğ°Ñ‚');
                    if (data.isGroup || data.isTeamChat) {
                        let participants = data.participants.map(p => p.firstName + ' ' + p.lastName).join(', ');
                        $('#chatParticipants').text('Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸: ' + participants);
                    }
                });
            }
        });

        // JS Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
        $(function() {
            const groupAvatarInput = document.getElementById('groupAvatarInput');
            const groupAvatarForm = document.getElementById('groupAvatarForm');
            if (groupAvatarInput && groupAvatarForm) {
                groupAvatarInput.addEventListener('change', function() {
                    if (!this.files.length) return;
                    const formData = new FormData();
                    formData.append('chatId', '@ViewBag.ChatId');
                    formData.append('avatar', this.files[0]);
                    $.ajax({
                        url: '/Chat/UploadGroupAvatar',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(data) {
                            if (data.success && data.avatarPath) {
                                $('#groupAvatarImg').attr('src', data.avatarPath + '?_=' + new Date().getTime());
                            } else {
                                alert(data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ¸!');
                            }
                        },
                        error: function() {
                            alert('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ĞºĞ¸!');
                        }
                    });
                });
            }
        });

        // --- Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ ---
        const emojiData = {
            smileys: ["ğŸ˜€","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜ƒ","ğŸ˜„","ğŸ˜…","ğŸ˜†","ğŸ˜‰","ğŸ˜Š","ğŸ˜‹","ğŸ˜","ğŸ˜","ğŸ˜˜","ğŸ¥°","ğŸ˜—","ğŸ˜™","ğŸ˜š","ğŸ™‚","ğŸ¤—","ğŸ¤©","ğŸ¤”","ğŸ¤¨","ğŸ˜","ğŸ˜‘","ğŸ˜¶","ğŸ™„","ğŸ˜","ğŸ˜£","ğŸ˜¥","ğŸ˜®","ğŸ¤","ğŸ˜¯","ğŸ˜ª","ğŸ˜«","ğŸ¥±","ğŸ˜´","ğŸ˜Œ","ğŸ˜›","ğŸ˜œ","ğŸ˜","ğŸ¤¤","ğŸ˜’","ğŸ˜“","ğŸ˜”","ğŸ˜•","ğŸ™ƒ","ğŸ¤‘","ğŸ˜²","â˜¹ï¸","ğŸ™","ğŸ˜–","ğŸ˜","ğŸ˜Ÿ","ğŸ˜¤","ğŸ˜¢","ğŸ˜­","ğŸ˜¦","ğŸ˜§","ğŸ˜¨","ğŸ˜©","ğŸ¤¯","ğŸ˜¬","ğŸ˜°","ğŸ˜±","ğŸ¥µ","ğŸ¥¶","ğŸ˜³","ğŸ¤ª","ğŸ˜µ","ğŸ˜¡","ğŸ˜ ","ğŸ¤¬","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤¢","ğŸ¤–","ğŸ¤—","ğŸ˜‡","ğŸ¥³"],
            animals: ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ™ˆ","ğŸ™‰","ğŸ™Š","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤","ğŸ£","ğŸ¥","ğŸ¦†","ğŸ¦…","ğŸ¦‰","ğŸ¦‡","ğŸº","ğŸ—","ğŸ´","ğŸ¦„","ğŸ","ğŸ›","ğŸ¦‹","ğŸŒ","ğŸ","ğŸœ","ğŸ¦Ÿ","ğŸ¦—","ğŸ•·","ğŸ¦‚","ğŸ¢","ğŸ","ğŸ¦","ğŸ¦–","ğŸ¦•","ğŸ™","ğŸ¦‘","ğŸ¦","ğŸ¦","ğŸ¦€","ğŸ¡","ğŸ ","ğŸŸ","ğŸ¬","ğŸ³","ğŸ‹","ğŸ¦ˆ","ğŸŠ","ğŸ…","ğŸ†","ğŸ¦“","ğŸ¦","ğŸ¦§","ğŸ˜","ğŸ¦›","ğŸ¦","ğŸª","ğŸ«","ğŸ¦’","ğŸ¦˜","ğŸ¦¥","ğŸ¦¦","ğŸ¦¨","ğŸ¦¡","ğŸ","ğŸ€","ğŸ¿","ğŸ¦”"],
            food: ["ğŸ","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸŒ","ğŸ‰","ğŸ‡","ğŸ“","ğŸ«","ğŸˆ","ğŸ’","ğŸ‘","ğŸ¥­","ğŸ","ğŸ¥¥","ğŸ¥","ğŸ…","ğŸ†","ğŸ¥‘","ğŸ¥¦","ğŸ¥¬","ğŸ¥’","ğŸŒ¶","ğŸ«‘","ğŸŒ½","ğŸ¥•","ğŸ«’","ğŸ§„","ğŸ§…","ğŸ¥”","ğŸ ","ğŸ¥","ğŸ¥¯","ğŸ","ğŸ¥–","ğŸ¥¨","ğŸ¥","ğŸ§‡","ğŸ§€","ğŸ–","ğŸ—","ğŸ¥©","ğŸ¥“","ğŸ”","ğŸŸ","ğŸ•","ğŸŒ­","ğŸ¥ª","ğŸŒ®","ğŸŒ¯","ğŸ¥™","ğŸ§†","ğŸ¥š","ğŸ³","ğŸ¥˜","ğŸ²","ğŸ¥£","ğŸ¥—","ğŸ¿","ğŸ§ˆ","ğŸ§‚","ğŸ¥«","ğŸ±","ğŸ˜","ğŸ™","ğŸš","ğŸ›","ğŸœ","ğŸ","ğŸ ","ğŸ¢","ğŸ£","ğŸ¤","ğŸ¥","ğŸ¥®","ğŸ¡","ğŸ¥Ÿ","ğŸ¥ ","ğŸ¥¡","ğŸ¦ª","ğŸ¦","ğŸ§","ğŸ¨","ğŸ©","ğŸª","ğŸ‚","ğŸ°","ğŸ§","ğŸ¥§","ğŸ«","ğŸ¬","ğŸ­","ğŸ®","ğŸ¯","ğŸ¼","ğŸ¥›","â˜•","ğŸµ","ğŸ§ƒ","ğŸ¥¤","ğŸ§‹","ğŸ¶","ğŸº","ğŸ»","ğŸ¥‚","ğŸ·","ğŸ¥ƒ","ğŸ¸","ğŸ¹","ğŸ¾","ğŸ§‰","ğŸ§Š"],
            activity: ["âš½","ğŸ€","ğŸˆ","âš¾","ğŸ¥","ğŸ¾","ğŸ","ğŸ‰","ğŸ¥","ğŸ±","ğŸª€","ğŸ“","ğŸ¸","ğŸ¥…","ğŸ’","ğŸ‘","ğŸ","ğŸ¥","ğŸ¹","ğŸ£","ğŸ¤¿","ğŸ¥Š","ğŸ¥‹","ğŸ½","ğŸ›¹","ğŸ›·","â›¸","ğŸ¥Œ","ğŸ¿","â›·","ğŸ‚","ğŸª‚","ğŸ‹ï¸â€â™‚ï¸","ğŸ‹ï¸â€â™€ï¸","ğŸ¤¼â€â™‚ï¸","ğŸ¤¼â€â™€ï¸","ğŸ¤¸â€â™‚ï¸","ğŸ¤¸â€â™€ï¸","â›¹ï¸â€â™‚ï¸","â›¹ï¸â€â™€ï¸","ğŸ¤º","ğŸ¤¾â€â™‚ï¸","ğŸ¤¾â€â™€ï¸","ğŸŒï¸â€â™‚ï¸","ğŸŒï¸â€â™€ï¸","ğŸ‡","ğŸ§˜â€â™‚ï¸","ğŸ§˜â€â™€ï¸","ğŸ„â€â™‚ï¸","ğŸ„â€â™€ï¸","ğŸŠâ€â™‚ï¸","ğŸŠâ€â™€ï¸","ğŸ¤½â€â™‚ï¸","ğŸ¤½â€â™€ï¸","ğŸš£â€â™‚ï¸","ğŸš£â€â™€ï¸","ğŸ§—â€â™‚ï¸","ğŸ§—â€â™€ï¸","ğŸšµâ€â™‚ï¸","ğŸšµâ€â™€ï¸","ğŸš´â€â™‚ï¸","ğŸš´â€â™€ï¸","ğŸ†","ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","ğŸ…","ğŸ–","ğŸµ","ğŸ—","ğŸ«","ğŸŸ","ğŸª","ğŸ¤¹â€â™‚ï¸","ğŸ¤¹â€â™€ï¸","ğŸ­","ğŸ©°","ğŸ¨","ğŸ¬","ğŸ¤","ğŸ§","ğŸ¼","ğŸ¹","ğŸ¥","ğŸ·","ğŸº","ğŸ¸","ğŸ»","ğŸ²","â™Ÿ","ğŸ³","ğŸ®","ğŸ°"],
            travel: ["ğŸš—","ğŸš•","ğŸš™","ğŸšŒ","ğŸš","ğŸ","ğŸš“","ğŸš‘","ğŸš’","ğŸš","ğŸ›»","ğŸšš","ğŸš›","ğŸšœ","ğŸ¦¯","ğŸ¦½","ğŸ¦¼","ğŸ›´","ğŸš²","ğŸ›µ","ğŸ","ğŸ›º","ğŸš¨","ğŸš”","ğŸš","ğŸš˜","ğŸš–","ğŸš¡","ğŸš ","ğŸšŸ","ğŸšƒ","ğŸš‹","ğŸš","ğŸš","ğŸš„","ğŸš…","ğŸšˆ","ğŸš‚","ğŸš†","ğŸš‡","ğŸšŠ","ğŸš‰","âœˆï¸","ğŸ›«","ğŸ›¬","ğŸ›©","ğŸ’º","ğŸ›°","ğŸš€","ğŸ›¸","ğŸš","ğŸ›¶","â›µ","ğŸš¤","ğŸ›¥","ğŸ›³","â›´","ğŸš¢","âš“","ğŸª","â›½","ğŸš§","ğŸš¦","ğŸš¥","ğŸš","ğŸ—º","ğŸ—¿","ğŸ—½","ğŸ—¼","ğŸ°","ğŸ¯","ğŸŸ","ğŸ¡","ğŸ¢","ğŸ ","â›²","â›±","ğŸ–","ğŸ","ğŸœ","ğŸŒ‹","â›°","ğŸ”","ğŸ—»","ğŸ•","â›º","ğŸ ","ğŸ¡","ğŸ˜","ğŸš","ğŸ—","ğŸ­","ğŸ¢","ğŸ¬","ğŸ£","ğŸ¤","ğŸ¥","ğŸ¦","ğŸ¨","ğŸ©","ğŸª","ğŸ«","ğŸ©","ğŸ’’","ğŸ›","â›ª","ğŸ•Œ","ğŸ›•","ğŸ•","ğŸ•‹","â›©","ğŸ›¤","ğŸ›£","ğŸ—¾","ğŸ‘","ğŸ","ğŸŒ…","ğŸŒ„","ğŸŒ ","ğŸ‡","ğŸ†","ğŸŒ‡","ğŸŒ†","ğŸ™","ğŸŒ‰","ğŸŒ"],
            symbols: ["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ–¤","ğŸ¤","ğŸ¤","ğŸ’”","â£ï¸","ğŸ’•","ğŸ’","ğŸ’“","ğŸ’—","ğŸ’–","ğŸ’˜","ğŸ’","ğŸ’Ÿ","â˜®ï¸","âœï¸","â˜ªï¸","ğŸ•‰","â˜¸ï¸","âœ¡ï¸","ğŸ”¯","ğŸ•","â˜¯ï¸","â˜¦ï¸","ğŸ›","â›","â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™","â™","â™","â™‘","â™’","â™“","ğŸ†”","âš›ï¸","ğŸ‰‘","â˜¢ï¸","â˜£ï¸","ğŸ“´","ğŸ“³","ğŸˆ¶","ğŸˆš","ğŸˆ¸","ğŸˆº","ğŸˆ·ï¸","âœ´ï¸","ğŸ†š","ğŸ’®","ğŸ‰","ãŠ™ï¸","ãŠ—ï¸","ğŸˆ´","ğŸˆµ","ğŸˆ¹","ğŸˆ²","ğŸ…°ï¸","ğŸ…±ï¸","ğŸ†","ğŸ†‘","ğŸ…¾ï¸","ğŸ†˜","âŒ","â­•","ğŸ›‘","â›”","ğŸ“›","ğŸš«","ğŸ’¯","ğŸ’¢","â™¨ï¸","ğŸš·","ğŸš¯","ğŸš³","ğŸš±","ğŸ”","ğŸ“µ","ğŸš­","â—","â“","â€¼ï¸","â‰ï¸","ğŸ”…","ğŸ”†","ã€½ï¸","âš ï¸","ğŸš¸","ğŸ”±","âšœï¸","ğŸ”°","â™»ï¸","âœ…","ğŸˆ¯","ğŸ’¹","â‡ï¸","âœ³ï¸","â","ğŸŒ","ğŸ’ ","â“‚ï¸","ğŸŒ€","ğŸ’¤","ğŸ§","ğŸš¾","â™¿","ğŸ…¿ï¸","ğŸ›—","ğŸš¹","ğŸšº","ğŸš¼","ğŸš»","ğŸš®","ğŸ¦","ğŸ“¶","ğŸˆ","ğŸ”£","â„¹ï¸","ğŸ”¤","ğŸ”¡","ğŸ” ","ğŸ†–","ğŸ†—","ğŸ†™","ğŸ†’","ğŸ†“","ğŸ†”","ğŸ†•","ğŸ†–","ğŸ†—","ğŸ†˜","ğŸ†™","ğŸ†š","ğŸ†›","ğŸ†œ","ğŸ†","ğŸ†","ğŸ†Ÿ","ğŸ† ","ğŸ†¡","ğŸ†¢","ğŸ†£","ğŸ†¤","ğŸ†¥","ğŸ†¦","ğŸ†§","ğŸ†¨","ğŸ†©","ğŸ†ª","ğŸ†«","ğŸ†¬","ğŸ†­","ğŸ†®","ğŸ†¯","ğŸ†°","ğŸ†±","ğŸ†²","ğŸ†³","ğŸ†´","ğŸ†µ","ğŸ†¶","ğŸ†·","ğŸ†¸","ğŸ†¹","ğŸ†º","ğŸ†»","ğŸ†¼","ğŸ†½","ğŸ†¾","ğŸ†¿"]
        };
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiList = document.getElementById('emojiList');
        const emojiCategories = document.getElementById('emojiCategories');
        const messageInput = document.getElementById('messageInput');
        let currentCat = 'smileys';
        function renderEmojiList(cat) {
            emojiList.innerHTML = '';
            emojiData[cat].forEach(e => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-btn-telegram';
                btn.textContent = e;
                btn.onclick = function() {
                    // Ğ’ÑÑ‚Ğ°Ğ²ĞºĞ° ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ² Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ¼ĞµÑÑ‚Ğ¾ ĞºÑƒÑ€ÑĞ¾Ñ€Ğ°
                    const start = messageInput.selectionStart;
                    const end = messageInput.selectionEnd;
                    const value = messageInput.value;
                    messageInput.value = value.substring(0, start) + e + value.substring(end);
                    messageInput.focus();
                    messageInput.selectionStart = messageInput.selectionEnd = start + e.length;
                    emojiPanel.style.display = 'none';
                };
                emojiList.appendChild(btn);
            });
        }
        if (emojiBtn && emojiPanel && emojiList && emojiCategories) {
            emojiBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (emojiPanel.style.display === 'none') {
                    renderEmojiList(currentCat);
                    emojiPanel.style.display = 'block';
                } else {
                    emojiPanel.style.display = 'none';
                }
            });
            emojiCategories.querySelectorAll('.emoji-cat-btn').forEach(btn => {
                btn.onclick = function() {
                    emojiCategories.querySelectorAll('.emoji-cat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCat = btn.getAttribute('data-cat');
                    renderEmojiList(currentCat);
                };
            });
            // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ
            document.addEventListener('mousedown', function(e) {
                if (emojiPanel.style.display === 'block' && !emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                    emojiPanel.style.display = 'none';
                }
            });
        }

        // --- Ğ ĞµĞ°Ğ»Ñ‚Ğ°Ğ¹Ğ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ¾ Ğ¿Ñ€Ğ¾Ñ‡Ñ‚ĞµĞ½Ğ¸Ğ¸ ---
        function markVisibleMessagesAsRead() {
            $(".message-bubble").each(function() {
                const msgId = $(this).data("message-id");
                const isMine = $(this).hasClass("my-message");
                if (!isMine && isElementInViewport(this)) {
                    $.post("/Chat/MarkAsRead", { messageId: msgId });
                    connection.invoke("NotifyMessageRead", chatId, msgId, userId);
                }
            });
        }
        function isElementInViewport(el) {
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight)
            );
        }
        $(function() {
            markVisibleMessagesAsRead();
            $("#messagesList").on("scroll", function() { markVisibleMessagesAsRead(); });
        });
        // --- Ğ“Ğ°Ğ»Ğ¾Ñ‡ĞºĞ° "Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¾" ---
        function updateReadStatus() {
            $(".my-message").each(function() {
                const msgId = $(this).data("message-id");
                const $status = $(this).find(".message-status");
                // Ğ•ÑĞ»Ğ¸ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºĞ° â€” Ğ½Ğµ Ğ¾Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼
                if ($status.find('.read-status').length > 0) return;
                $.get(`/Chat/IsMessageReadByAll?messageId=${msgId}`, function(data) {
                    if (data.isRead) {
                        $status.html("<span class='read-status ms-1' title='ĞŸÑ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¾'><i class='bi bi-check2-all text-primary'></i></span>");
                    }
                });
            });
        }
        $(function() { updateReadStatus(); });
        // --- SignalR: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ñ€Ğ¾Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ ---
        connection.on("MessageRead", function(msgChatId, msgId, readUserId) {
            if (msgChatId == chatId) updateReadStatus();
        });
    </script>
} 